<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Pedidos | Dety Parfum</title>
	<link href="/assets/tailwind/output.css" rel="stylesheet" />
	<script src="https://unpkg.com/lucide@latest"></script>
	<style>
		body {
			font-family: 'Crimson Text', serif;
		}

		.modal {
			transition: all 0.3s ease-in-out;
		}
	</style>
</head>

<body class="bg-purple-50 text-gray-800">
	<!-- Bot√£o mobile -->
	<button id="menu-toggle"
		class="fixed top-4 left-4 z-50 md:hidden bg-purple-700 text-white px-3 py-2 rounded shadow">
		‚ò∞
	</button>

	<div class="flex min-h-screen">
		<!-- Sidebar -->

		<aside id="sidebar"
			class="w-64 bg-white shadow-xl border-r border-purple-200 flex flex-col p-4 fixed top-0 left-0 bottom-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
			<div class="flex items-center justify-center mb-6">
				<h1 class="text-2xl font-bold text-purple-700">Dety Parfum</h1>
			</div>
			<div class="mb-4">
				<input type="text" placeholder="Buscar no menu..."
					class="w-full px-3 py-2 border border-purple-300 rounded-md focus:ring-2 focus:ring-purple-400 outline-none" />
			</div>

			<nav class="flex-1 space-y-2">
				<a href="/index.html"
					class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition text-purple-700 font-semibold">
					üè† <span class="ml-2">Dashboard</span>
				</a>
				<a href="/clientes.html"
					class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üë§ <span
						class="ml-2">Clientes</span></a>
				<a href="/produto.html" class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üì¶
					<span class="ml-2">Produtos</span></a>
				<a href="/pedido.html" class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üßæ
					<span class="ml-3">Pedidos</span></a>
				<a href="/pagamento.html"
					class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üí≥ <span
						class="ml-2">Pagamentos</span></a>
				<a href="/relatorios.html"
					class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üìä <span
						class="ml-2">Relat√≥rios</span></a>
				<a href="/usuarios.html"
					class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üîê <span
						class="ml-2">Usu√°rios</span></a>
				<a href="/configuracoes.html"
					class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">‚öôÔ∏è <span
						class="ml-2">Configura√ß√µes</span></a>
				<a href="/backup.html" class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">üíæ
					<span class="ml-2">Backup</span></a>
				<a href="/alertas.html" class="flex items-center px-4 py-2 rounded-lg hover:bg-purple-100 transition">‚ö†Ô∏è
					<span class="ml-2">Alertas</span></a>
			</nav>

			<div class="mt-auto pt-6 border-t border-purple-200 text-sm text-center text-purple-500">
				Sistema de gest√£o exclusivo criado por Guilherme Kaiser.
			</div>
		</aside>

		<main class="flex-1 px-6 py-10 w-full md:ml-64 mt-16 md:mt-0 transition-all duration-300">
			<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
				<h1 class="text-3xl font-bold text-purple-700">Pedidos</h1>
				<div class="flex flex-col sm:flex-row gap-2">
					<input id="barraBusca" type="text" placeholder="Buscar por cliente, status ou data..."
						class="px-3 py-2 border border-purple-300 rounded-md focus:ring-2 focus:ring-purple-500 w-full sm:w-64" />
					<button id="btnOpenModal"
						class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-md">
						<i data-lucide="plus"></i> Novo Pedido
					</button>
				</div>
			</div>

			<div class="overflow-x-auto">
				<table class="min-w-full table-auto bg-white rounded shadow">
					<thead class="bg-purple-100">
						<tr>
							<th class="text-left p-3">Cliente</th>
							<th class="text-left p-3">Data</th>
							<th class="text-left p-3">Status</th>
							<th class="text-left p-3">Itens</th>
							<th class="text-left p-3">Pagamentos</th>
							<th class="text-left p-3">Observa√ß√£o</th>
							<th class="text-left p-3">A√ß√µes</th>
						</tr>
					</thead>
					<tbody id="pedidosTable" class="divide-y"></tbody>
				</table>
			</div>

			<div class="mt-4 flex justify-between items-center">
				<button id="btnAnterior" class="px-4 py-2 bg-purple-200 text-purple-800 rounded disabled:opacity-50">‚¨Ö
					Anterior</button>
				<span class="text-purple-700 font-semibold">P√°gina <span id="numeroPagina">1</span></span>
				<button id="btnProxima"
					class="px-4 py-2 bg-purple-200 text-purple-800 rounded disabled:opacity-50">Pr√≥xima ‚û°</button>
			</div>

			<div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
				<div
					class="bg-white rounded-lg shadow-lg w-full max-w-3xl p-6 modal scale-95 opacity-0 overflow-y-auto max-h-[90vh]">
					<h2 id="modalTitle" class="text-xl font-bold text-purple-700 mb-4">Cadastrar Pedido</h2>
					<form id="pedidoForm" class="space-y-4">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium mb-1">Cliente</label>
								<select id="clienteId" required
									class="w-full border border-purple-300 rounded px-3 py-2"></select>
							</div>
							<div>
								<label class="block text-sm font-medium mb-1">Status</label>
								<select id="status" required
									class="w-full border border-purple-300 rounded px-3 py-2 focus:ring-2 focus:ring-purple-500">
									<option value="AGUARDANDO_PAGAMENTO">Aguardando Pagamento</option>
									<option value="PAGO">Pago</option>
									<option value="CANCELADO">Cancelado</option>
								</select>
							</div>
						</div>
						<div class="rounded-lg border border-purple-200 bg-purple-50/40 p-3">
							<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
								<label class="text-sm font-medium">Itens do Pedido</label>
								<button type="button" id="addItem" class="text-purple-600 hover:underline">+ Adicionar
									Item</button>
							</div>
							<div id="itensContainer" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
							<p class="text-xs text-purple-600 mt-2">A busca √© exibida em lista rol√°vel para facilitar a
								sele√ß√£o sem expandir a tela.</p>
						</div>
						<div class="rounded-lg border border-purple-200 bg-purple-50/40 p-3">
							<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
								<label class="text-sm font-medium">Pagamentos</label>
								<button type="button" id="addPagamento" class="text-purple-600 hover:underline">+
									Adicionar Pagamento</button>
							</div>
							<div id="pagamentosContainer" class="space-y-3 max-h-48 overflow-y-auto pr-2"></div>
							<p class="text-xs text-purple-600 mt-2">Adicione quantas parcelas forem necess√°rias, inclusive
								pagamentos repetidos em dinheiro.</p>
						</div>
						<div>
							<label class="block text-sm font-medium mb-1">Observa√ß√£o</label>
							<textarea id="observacao"
								class="w-full border border-purple-300 rounded px-3 py-2"></textarea>
						</div>
						<div class="flex justify-end gap-2">
							<button type="button" id="btnCloseModal"
								class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancelar</button>
							<button type="submit"
								class="px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700">Salvar</button>
						</div>
					</form>
				</div>
			</div>
		</main>
	</div>

	<script>
		lucide.createIcons();

		const modal = document.getElementById("modal");
		const btnOpenModal = document.getElementById("btnOpenModal");
		const btnCloseModal = document.getElementById("btnCloseModal");
		const pedidosTable = document.getElementById("pedidosTable");
		const pedidoForm = document.getElementById("pedidoForm");
		const clienteId = document.getElementById("clienteId");
		const status = document.getElementById("status");
		const observacao = document.getElementById("observacao");
		const itensContainer = document.getElementById("itensContainer");
		const pagamentosContainer = document.getElementById("pagamentosContainer");
		const addItemBtn = document.getElementById("addItem");
		const addPagamentoBtn = document.getElementById("addPagamento");
		const barraBusca = document.getElementById("barraBusca");
		const btnAnterior = document.getElementById("btnAnterior");
		const btnProxima = document.getElementById("btnProxima");
		const numeroPagina = document.getElementById("numeroPagina");
		const modalTitle = document.getElementById("modalTitle");

		let pedidoEditandoId = null;
		let pedidoDataEditando = null;
		let clientes = [];
		let produtos = [];
		let pedidos = [];
		let paginaAtual = 0;
		const tamanhoPagina = 15;

		const statusLabels = {
			AGUARDANDO_PAGAMENTO: "Aguardando Pagamento",
			PAGO: "Pago",
			CANCELADO: "Cancelado"
		};

		async function carregarClientes() {
			const res = await fetch("/clientes");
			clientes = await res.json();
			clienteId.innerHTML = clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
		}

		async function carregarProdutos() {
			const res = await fetch("/produtos");
			produtos = await res.json();
		}

		function criarItem(itemId = null, produtoSelecionado = null, quantidade = 1, preco = null) {
			const div = document.createElement("div");
			div.className = "grid grid-cols-[minmax(0,1fr)_90px_110px_auto] gap-2 items-start";
			if (itemId) div.dataset.itemId = itemId;

			const produto = produtos.find(p => p.id === produtoSelecionado);
			const nomeProduto = produto ? produto.nome : "";

			div.innerHTML = `
		      <div class="relative">
		        <input type="text" autocomplete="off" class="produtoBusca border px-2 py-2 rounded w-full" value="${nomeProduto}" placeholder="Buscar produto..." />
		        <input type="hidden" class="produtoId" value="${produtoSelecionado ?? ''}" />
		        <div class="sugestoes hidden absolute left-0 right-0 top-full mt-1 rounded border border-purple-200 bg-white shadow-lg max-h-52 overflow-y-auto z-20"></div>
		      </div>
		      <input type="number" min="1" value="${quantidade}" placeholder="Qtd" class="quantidade border px-2 py-2 rounded w-full" />
		      <input type="number" step="0.01" placeholder="Pre√ßo" class="preco border px-2 py-2 rounded w-full" value="${preco ?? ''}" />
		      <button type="button" class="removeItem text-red-600 mt-1"><i data-lucide="trash-2"></i></button>
		    `;

			const buscaInput = div.querySelector(".produtoBusca");
			const idInput = div.querySelector(".produtoId");
			const precoInput = div.querySelector(".preco");
			const sugestoes = div.querySelector(".sugestoes");

			if (preco === null && produto) {
				precoInput.value = produto.preco;
			}

			const selecionarProduto = (produtoSelecionado) => {
				buscaInput.value = produtoSelecionado.nome;
				idInput.value = produtoSelecionado.id;
				precoInput.value = produtoSelecionado.preco;
				sugestoes.classList.add("hidden");
			};

			const renderSugestoes = (termo = "") => {
				const termoBusca = termo.toLowerCase();
				const filtrados = produtos.filter(p => p.nome.toLowerCase().includes(termoBusca));
				const limite = 80;
				const exibidos = filtrados.slice(0, limite);
				sugestoes.innerHTML = exibidos.map(p => `
					<div class="px-3 py-2 hover:bg-purple-100 cursor-pointer" data-produto-id="${p.id}" data-produto-preco="${p.preco}" data-produto-nome="${p.nome}">
						<strong>${p.nome}</strong>
						<div class="text-xs text-gray-500">R$ ${p.preco?.toFixed(2)}</div>
					</div>
				`).join('');

				if (filtrados.length === 0) {
					sugestoes.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">Nenhum produto encontrado.</div>';
				}

				if (filtrados.length > limite) {
					sugestoes.innerHTML += '<div class="px-3 py-2 text-xs text-gray-500">Refine sua busca para ver mais resultados.</div>';
				}

				sugestoes.classList.remove("hidden");
			};

			buscaInput.addEventListener("input", () => renderSugestoes(buscaInput.value));
			buscaInput.addEventListener("focus", () => renderSugestoes(buscaInput.value));
			buscaInput.addEventListener("blur", () => setTimeout(() => sugestoes.classList.add("hidden"), 150));

			sugestoes.addEventListener("mousedown", (event) => {
				const item = event.target.closest("[data-produto-id]");
				if (!item) return;
				selecionarProduto({
					id: parseInt(item.dataset.produtoId, 10),
					nome: item.dataset.produtoNome,
					preco: parseFloat(item.dataset.produtoPreco)
				});
			});

			const remover = div.querySelector(".removeItem");
			remover.addEventListener("click", async () => {
				if (div.dataset.itemId) {
					const token = await getCsrfToken();
					await fetch(`/pedidos/${pedidoForm.dataset.id}/itens/${div.dataset.itemId}`, {
						method: "DELETE",
						headers: { "X-XSRF-TOKEN": token },
						credentials: "same-origin"
					});
				}
				div.remove();
			});

			itensContainer.appendChild(div);
			lucide.createIcons();
		}

		function criarPagamento(tipo = "DINHEIRO", parcelas = "", valor = "") {
			const div = document.createElement("div");
			div.className = "grid grid-cols-[minmax(0,1fr)_90px_110px_auto] gap-2 items-center";
			div.innerHTML = `
		    <select class="tipo border px-2 py-2 rounded w-full">
		      <option value="DINHEIRO" ${tipo === "DINHEIRO" ? "selected" : ""}>Dinheiro</option>
		      <option value="PIX" ${tipo === "PIX" ? "selected" : ""}>PIX</option>
		      <option value="CARTAO" ${tipo === "CARTAO" ? "selected" : ""}>Cart√£o</option>
		      <option value="PARCELADO" ${tipo === "PARCELADO" ? "selected" : ""}>Parcelado Manual</option>
		    </select>
		    <input type="number" min="1" placeholder="Parcelas" value="${parcelas ?? ''}" class="parcelas border px-2 py-2 rounded w-full" />
		    <input type="number" step="0.01" placeholder="Valor" value="${valor ?? ''}" class="valor border px-2 py-2 rounded w-full" />
		    <button type="button" class="removePagamento text-red-600"><i data-lucide="trash-2"></i></button>
		  `;
			div.querySelector(".removePagamento").addEventListener("click", () => div.remove());
			pagamentosContainer.appendChild(div);
			lucide.createIcons();
		}

		btnOpenModal.onclick = async () => {
			pedidoForm.dataset.id = "";
			pedidoEditandoId = null;
			pedidoDataEditando = null;
			modalTitle.textContent = "Cadastrar Pedido";
			await carregarClientes();
			await carregarProdutos();
			pedidoForm.reset();
			itensContainer.innerHTML = "";
			pagamentosContainer.innerHTML = "";
			criarItem();
			criarPagamento();
			modal.classList.remove("hidden");
			setTimeout(() => modal.querySelector(".modal").classList.add("scale-100", "opacity-100"), 10);
		};

		btnCloseModal.onclick = () => {
			modal.querySelector(".modal").classList.remove("scale-100", "opacity-100");
			setTimeout(() => modal.classList.add("hidden"), 200);
		};

		addItemBtn.onclick = () => criarItem();
		addPagamentoBtn.onclick = () => criarPagamento();

		pedidoForm.onsubmit = async (e) => {
			e.preventDefault();

			const itens = Array.from(itensContainer.children)
				.map(row => {
					const produtoId = parseInt(row.querySelector(".produtoId").value, 10);
					if (!produtoId) return null;
					return {
						produtoId,
						quantidade: parseInt(row.querySelector(".quantidade").value, 10) || 1,
						preco: parseFloat(row.querySelector(".preco").value)
					};
				})
				.filter(Boolean);

			const pagamentos = Array.from(pagamentosContainer.children)
				.map(row => {
					const valor = parseFloat(row.querySelector(".valor").value);
					if (Number.isNaN(valor)) return null;
					const parcelasValor = parseInt(row.querySelector(".parcelas").value, 10);
					return {
						tipo: row.querySelector(".tipo").value,
						parcelas: Number.isNaN(parcelasValor) ? null : parcelasValor,
						valor
					};
				})
				.filter(Boolean);

			const agora = new Date();
			const dataFormatada = (pedidoDataEditando ?? agora.toISOString()).slice(0, 19);

			const pedido = {
				clienteId: parseInt(clienteId.value, 10),
				status: status.value,
				observacao: observacao.value,
				data: dataFormatada,
				itens,
				pagamentos
			};

			const token = await getCsrfToken();
			const url = pedidoEditandoId ? `/pedidos/${pedidoEditandoId}` : "/pedidos";
			const method = pedidoEditandoId ? "PUT" : "POST";
			if (!pedidoEditandoId) {
				delete pedido.id;
			}

			const res = await fetch(url, {
				method,
				headers: {
					"Content-Type": "application/json",
					"X-XSRF-TOKEN": token
				},
				credentials: "same-origin",
				body: JSON.stringify(pedido)
			});

			if (res.ok) {
				alert("Pedido salvo com sucesso!");
				modal.classList.add("hidden");
				await listarPedidos();
			} else {
				alert("Erro ao salvar pedido.");
			}
		};
		async function listarPedidos() {
			const res = await fetch("/pedidos");
			pedidos = await res.json();
			renderTabela();
		}

		function renderTabela() {
			let termo = barraBusca.value.toLowerCase();
			let filtrados = pedidos.filter(p => {
				const clienteNome = clientes.find(c => c.id === p.clienteId)?.nome?.toLowerCase() || '';
				const statusPedido = (statusLabels[p.status] || p.status).toLowerCase();
				const dataPedido = new Date(p.data).toLocaleDateString('pt-BR');

				return clienteNome.includes(termo) || statusPedido.includes(termo) || dataPedido.includes(termo);
			});

			const inicio = paginaAtual * tamanhoPagina;
			const pagina = filtrados.slice(inicio, inicio + tamanhoPagina);

			pedidosTable.innerHTML = pagina.map(p => `
		    <tr>
		      <td class="p-3">${clientes.find(c => c.id === p.clienteId)?.nome || "N/A"}</td>
		      <td class="p-3">${new Date(p.data).toLocaleDateString('pt-BR')}</td>
		      <td class="p-3">${statusLabels[p.status] || p.status}</td>
		      <td class="p-3">${p.itens.length} itens</td>
		      <td class="p-3">${p.pagamentos.length} pagamentos</td>
		      <td class="p-3">${p.observacao || '-'}</td>
		      <td class="p-3">
		        <button onclick="editarPedido(${p.id})" title="Editar">‚úèÔ∏è</button>
		        <button onclick="excluirPedido(${p.id})" title="Excluir">üóëÔ∏è</button>
		      </td>
		    </tr>
		  `).join('');

			btnAnterior.disabled = paginaAtual === 0;
			btnProxima.disabled = (paginaAtual + 1) * tamanhoPagina >= filtrados.length;
			numeroPagina.textContent = paginaAtual + 1;
		}

		btnAnterior.onclick = () => {
			if (paginaAtual > 0) {
				paginaAtual--;
				renderTabela();
			}
		};

		barraBusca.addEventListener("input", () => {
			paginaAtual = 0;
			renderTabela();
		});

		btnProxima.onclick = () => {
			paginaAtual++;
			renderTabela();
		};

		async function excluirPedido(id) {
			if (!confirm("Deseja excluir este pedido?")) return;

			const resToken = await fetch("/csrf-token", { credentials: "same-origin" });
			const token = (await resToken.json()).token;

			try {
				const res = await fetch(`/pedidos/${id}`, {
					method: "DELETE",
					headers: {
						"X-XSRF-TOKEN": token
					},
					credentials: "same-origin"
				});

				if (res.ok) {
					alert("Pedido exclu√≠do com sucesso!");
					await listarPedidos();
				} else {
					alert("Erro ao excluir pedido. Verifique permiss√µes.");
				}
			} catch (error) {
				alert("Erro ao excluir pedido.");
			}
		}

		async function editarPedido(id) {
			await carregarClientes();
			await carregarProdutos();
			const res = await fetch(`/pedidos/${id}`);
			const pedido = await res.json();

			pedidoForm.dataset.id = pedido.id;
			pedidoEditandoId = pedido.id;
			pedidoDataEditando = pedido.data;
			modalTitle.textContent = "Editar Pedido";
			clienteId.value = pedido.clienteId;
			status.value = pedido.status;
			observacao.value = pedido.observacao || "";

			itensContainer.innerHTML = "";
			for (const item of pedido.itens) {
				criarItem(item.id, item.produtoId, item.quantidade, item.preco);
			}

			pagamentosContainer.innerHTML = "";
			for (const pagamento of pedido.pagamentos) {
				criarPagamento(pagamento.tipo, pagamento.parcelas, pagamento.valor);
			}

			modal.classList.remove("hidden");
			setTimeout(() => modal.querySelector(".modal").classList.add("scale-100", "opacity-100"), 10);
		}


		async function getCsrfToken() {
			const res = await fetch("/csrf-token", { credentials: "same-origin" });
			const data = await res.json();
			return data.token;
		}
		// Carregamento inicial
		(async () => {
			await carregarClientes();
			await carregarProdutos();
			await listarPedidos();
		})();

		// Sidebar toggle
		document.getElementById('menu-toggle').addEventListener('click', () => {
			document.getElementById('sidebar').classList.toggle('-translate-x-full');
		});
	</script>

</body>

</html>
